name: Pull Request CI

on:
  pull_request:
    branches: [main]
    types: [opened, synchronize, reopened]

env:
  NODE_VERSION: '20'

jobs:
  ci:
    name: Continuous Integration
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: ğŸ“š Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ—ï¸ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ğŸ“¦ Install dependencies
        run: npm ci --legacy-peer-deps

      - name: ğŸ” Type check
        run: npx tsc --noEmit

      - name: ğŸ§¹ ESLint check
        run: npm run lint

      - name: ğŸ’… Prettier check
        run: npx prettier --check "**/*.{js,jsx,ts,tsx,json,md,css}"

      - name: ğŸ§ª Run tests
        run: npm run test

      - name: ğŸ”’ Security audit
        run: npm audit --audit-level=moderate
        continue-on-error: true

      - name: ğŸ—ï¸ Build application
        run: npm run build
        env:
          NEXT_PUBLIC_SUPABASE_URL: "https://example.supabase.co"
          NEXT_PUBLIC_SUPABASE_ANON_KEY: "example-key"

      - name: ğŸ“ Bundle size check
        run: |
          echo "ğŸ“¦ Build analysis:"
          echo "Total build size:"
          du -sh .next/ || echo "Build folder not found"
          echo "Largest JavaScript bundles:"
          find .next/static -name "*.js" -type f -exec du -h {} + 2>/dev/null | sort -hr | head -5 || echo "No JS bundles found"

      - name: ğŸš« Check for debugging code
        run: |
          echo "Checking for console.log statements..."
          if grep -r "console\.log" --include="*.ts" --include="*.tsx" --include="*.js" --include="*.jsx" app/ ui/ hooks/ lib/ 2>/dev/null; then
            echo "âš ï¸ Found console.log statements. Consider removing them."
          else
            echo "âœ… No console.log statements found."
          fi
          
          echo "Checking for TODO/FIXME comments..."
          todos=$(grep -r "TODO\|FIXME" --include="*.ts" --include="*.tsx" --include="*.js" --include="*.jsx" app/ ui/ hooks/ lib/ 2>/dev/null || echo "")
          if [[ -n "$todos" ]]; then
            echo "ğŸ“ Found TODO/FIXME comments:"
            echo "$todos"
          else
            echo "âœ… No TODO/FIXME comments found."
          fi

      - name: âœ… CI Summary
        if: always()
        run: |
          echo "ğŸ‰ CI checks completed!"
          echo "ğŸ“‹ Summary:"
          echo "- âœ… Dependencies installed"
          echo "- âœ… TypeScript type checking"
          echo "- âœ… ESLint code quality"
          echo "- âœ… Prettier code formatting"
          echo "- âœ… Test suite execution"
          echo "- âœ… Security audit"
          echo "- âœ… Application build"
          echo "- âœ… Bundle size analysis"
          echo "- âœ… Code quality checks" 